% !TEX root = Paper.tex
\begin{figure}[t!]
    \centering
    \includegraphics[width=\columnwidth]{Images/HDT_Diagram.pdf} 
    \caption{Hybrid distribution transformer circuit diagram.}
    \label{fig:HDT_Transformer}
\end{figure}

The HDT configuration used in this paper is shown in \Cref{fig:HDT_Transformer}. It consists of a traditional DT connected to two back-to-back VSCs: a series converter connected to the primary of the DT through a CT, and a parallel converter connected in parallel to the load, which is connected to the secondary of the DT. All the state-space equations are derived in the $\alpha\beta$ reference frame, until otherwise specified.

\subsection{Series Converter}
The objectives of the series converter are to compensate for voltage disturbances, e.g. sags, swells and harmonics that may occur in the grid. This is done by injecting a voltage in series with the grid through the CT. The dynamics of the series converter are given by the following state-space equation:

\begin{equation}
    \dot{x}_s =
    \underbrace{
    \begin{bmatrix}
        -\frac{R_{fs}}{L_{fs}} \mathbf{I} & -\frac{1}{L_{fs}} \mathbf{I} \\
        \frac{1}{C_{fs}} \mathbf{I} & \mathbf{0}
    \end{bmatrix}
    }_{\mathbf{A}_s}
    x_s +
    \underbrace{
    \begin{bmatrix}
        \frac{1}{L_{fs}}\mathbf{I}\\
        \mathbf{0}
    \end{bmatrix}
    }_{\mathbf{B}_s}
    v_s +
    \underbrace{
    \begin{bmatrix}
        \mathbf{0} \\
        -\frac{1}{C_{fs}}\mathbf{I}
    \end{bmatrix}
    }_{\mathbf{P}_{is}}
    i_s \label{eq:SeriesConverter_Dynamics}
\end{equation}
where $x_s = \begin{bmatrix} i_{fs} & v_{cs} \end{bmatrix}^T$ is the state vector and $i_s$ is the currents that circulates to the CT. The parameters $R_{fs}$, $L_{fs}$, and $C_{fs}$ are the series converter filter resistance, inductance, and capacitance respectively.

The current $i_s$ is related to the transformer secondary side current $i_Y$ through $i_s = N_{CT} i_g$ relationship, where $N_{CT}$ is the CT turns ratio and $i_g$ is the grid current. The grid current can be expressed in terms of the transformer secondary side current and the parallel converter capacitor current as:
\begin{equation}
    i_g^{abc} = \dfrac{1}{N_{DT}}
    \begin{bmatrix}
        1 & 0 & -1 \\
        -1 & 1 & 0 \\
        0 & -1 & 1
    \end{bmatrix}
    i_Y^{abc}
\end{equation}
where $N_{DT}$ is the transformer turns ratio. Converting this to $\alpha\beta$ coordinates gives:
\begin{equation}
    i_g = \dfrac{1}{N_{DT}} \mathbf{K_{T\alpha\beta}}\, i_Y
\end{equation}
where the matrix that models the $\Delta-Y$ transformer is given by:
\begin{equation}
    \mathbf{K_{T\alpha\beta}} = 
    \begin{bmatrix} 
        \frac{2}{3} & \frac{\sqrt{3}}{2}\\
        -\frac{\sqrt{3}}{2} & \frac{3}{2} 
    \end{bmatrix}
\end{equation}
Substituting this into \eqref{eq:SeriesConverter_Dynamics} gives:
\begin{align}
    \begin{aligned}
        \dot{x}_s &= \mathbf{A}_s x_s + \mathbf{B}_s v_s + \mathbf{P}_{is} N_{CT} \dfrac{1}{N_{DT}} \mathbf{K_{T\alpha\beta}}\, i_Y
    \end{aligned}
\end{align}

\subsection{Parallel Converter}

The parallel converter is responsible for maintaining the dc-link voltage of the HDT and compensating load-side disturbances, including harmonics and unbalances that may be present. Its dynamics are expressed as:
\begin{align}
    \dot{x}_p &=
        \underbrace{\begin{bmatrix}
            -\tfrac{R_{fp}}{L_{fp}} \mathbf{I} & -\tfrac{1}{L_{fp}} \mathbf{I}\\
             \tfrac{1}{C_{fp}} \mathbf{I} & \mathbf{0}
        \end{bmatrix}}_{\mathbf{A}_p}
        x_p
        +
        \underbrace{\begin{bmatrix}
            \tfrac{1}{L_{fp}}\mathbf{I}\\
            \mathbf{0}
        \end{bmatrix}}_{\mathbf{B}_p} v_p
        +
        \underbrace{\begin{bmatrix}
            \mathbf{0}\\
            \tfrac{1}{C_{fp}}\mathbf{I}
        \end{bmatrix}}_{\mathbf{P}_{iY}} i_Y\\
        &+
        \underbrace{\begin{bmatrix}
            \mathbf{0}\\
            -\tfrac{1}{C_{fp}}\mathbf{I}
        \end{bmatrix}}_{\mathbf{P}_{iL}} i_L ,
    \label{eq:ParallelConverter}
\end{align}
where $x_p = \begin{bmatrix} i_{fp} & v_{cp} \end{bmatrix}^T$ and $i_L$ is the load current. The parameters $R_{fp}$, $L_{fp}$, and $C_{fp}$ are the parallel converter filter resistance, inductance, and capacitance, respectively.

\subsection{Transformer Dynamics}

The secondary voltage of the transformer $v_2$ can be expressed in terms of the primary voltage $v_1$, given by $v_g + N_{CT} v_{cs}$, as:
\begin{equation}
    v_2 = \frac{1}{N_{DT}} \mathbf{K_{T\alpha\beta}}' (N_{CT} v_{cs} + v_g),
\end{equation}
where $\mathbf{K_{T\alpha\beta}}'$ is the transpose of the transformation matrix. The transformer dynamics, modeled as a series impedance referred to the $Y$ side, are:
\begin{align}
    \dot{i_Y} = -\frac{R_Y}{L_Y}i_Y - \frac{1}{L_Y} v_{cp}
    + \frac{1}{L_Y}\frac{1}{N_{DT}} \mathbf{K_{T\alpha\beta}}'(v_g + N_{CT} v_{cs}),
    \label{eq:Transformer}
\end{align}
with $R_Y$ and $L_Y$ being the transformer series resistance and leakage inductance, respectively. The coupling matrices are
\[
    \mathbf{P}_{vg} = \frac{1}{L_Y}\frac{1}{N_{DT}} \mathbf{K_{T\alpha\beta}}', \qquad
    \mathbf{P}_{vc} = \frac{1}{L_Y}\frac{N_{CT}}{N_{DT}} \mathbf{K_{T\alpha\beta}}' .
\]

\subsection{Overall HDT Model}

By combining the series converter, parallel converter, and transformer dynamics, the overall state-space model of the HDT can be compactly expressed as:
\begin{align}
    \begin{aligned}
        \begin{bmatrix}
            \dot{x}_s\\
            \dot{x}_p\\
            \dot{i_Y}
        \end{bmatrix}
        &=
        \underbrace{\begin{bmatrix}
            \mathbf{A}_s & \mathbf{0} & \mathbf{0}\\
            \mathbf{0} & \mathbf{A}_p & \mathbf{P}_{iY}\\
            \mathbf{P}_{vc}\mathbf{M} & -\tfrac{1}{L_Y}\mathbf{M} & -\tfrac{R_Y}{L_Y}\mathbf{I}
        \end{bmatrix}}_{\mathbf{A}}
        \begin{bmatrix}
            x_s\\
            x_p\\
            i_Y
        \end{bmatrix}
        \\
        &+
        \underbrace{\begin{bmatrix}
            \mathbf{B}_s & \mathbf{0}\\
            \mathbf{0} & \mathbf{B}_p\\
            \mathbf{0} & \mathbf{0}
        \end{bmatrix}}_{\mathbf{B}}
        \begin{bmatrix}
            v_s\\[2pt]
            v_p
        \end{bmatrix} \nonumber
        +
        \underbrace{\begin{bmatrix}
            \mathbf{0} & \mathbf{0}\\
            \mathbf{0} & \mathbf{P}_{iL}\\
            \mathbf{P}_{vg} & \mathbf{0}
        \end{bmatrix}}_{\mathbf{P}}
        \begin{bmatrix}
            v_g\\
            i_L
        \end{bmatrix},
        \label{eq:HDT_compact}
    \end{aligned}
\end{align}
with the overall state vector $x = \begin{bmatrix} x_s^T & x_p^T & i_Y^T \end{bmatrix}^T$ and input vector $u = \begin{bmatrix} v_s^T & v_p^T \end{bmatrix}^T$. The selection matrix $\mathbf{M} = \begin{bmatrix} \mathbf{0} & \mathbf{I} \end{bmatrix}$ extract the capacitor voltages $v_{cp}$ and $v_{cs}$ from the parallel and series converter states, respectively.

The HDT system is discretized using a zero-order hold which gives the following state-space model:
\begin{align}
    \begin{aligned}
        x_{k + 1} &= \mathbf{A}_d x_k + \mathbf{B}_d u_k + \mathbf{P}_{vg,d} {v_g}_k + \mathbf{P}_{iL,d} {i_L}_k\\
        y_k &= \mathbf{C} x_k
    \end{aligned}
\end{align}
where $\mathbf{A}_d = e^{\mathbf{A}T_s}$, $\mathbf{B}_d = \int_0^{T_s} e^{\mathbf{A}\tau} d\tau \mathbf{B}$, $\mathbf{P}_{vg,d} = \int_0^{T_s} e^{\mathbf{A}\tau} d\tau \mathbf{P}_{vg}$, $\mathbf{P}_{iL,d} = \int_0^{T_s} e^{\mathbf{A}\tau} d\tau \mathbf{P}_{iL}$, and $\mathbf{C} = \mathbb{I}$.

In most of the applications, there is a delay of one sampling period between the calculation of the control input and its application to the system. To account for this delay, the discrete-time state-space model is augmented with a new state representing the previous control input:
\begin{equation}
    u_{k + 1} = m_k 
\end{equation}
This can be expressed in state-space form as:
\begin{align}
    \begin{aligned}
        \begin{bmatrix}
            x_{k + 1}\\
            u_{k + 1}
        \end{bmatrix}
        &=
        \underbrace{
        \begin{bmatrix}
            \mathbf{A}_d & \mathbf{B}_d \\
            \mathbf{0} & \mathbf{0}
        \end{bmatrix}
        }_{\mathbf{A}_{d,\text{delay}}}
        \begin{bmatrix}
            x_k\\
            u_k
        \end{bmatrix}
        +
        \underbrace{
        \begin{bmatrix}
            \mathbf{0}\\
            \mathbf{I}
        \end{bmatrix}
        }_{\mathbf{B}_{d,\text{delay}}}
        m_k \label{eq:AugmentedModel}
    \end{aligned}
\end{align}
where $\mathbf{A}_{d,\text{delay}}$ and $\mathbf{B}_{d,\text{delay}}$ are the augmented system and input matrices respectively.